<html><head><title>Easy-DHPSF 2.0: open-source software for three-dimensional localization and two-color registration of single molecules with nanoscale accuracy</title></head><body><h1>Easy-DHPSF 2.0: open-source software for three-dimensional localization and two-color registration of single molecules with nanoscale accuracy</h1>Authors: Camille Bayas, Alex von Diezmann, Anna-Karin Gustavsson, W. E. Moerner<br>Abstract: <p>Automated processing of double-helix (DH) microscope images of fluorescent single molecules (SMs) streamlines the protocol required to obtain super-resolved three-dimensional (3D) reconstructions of ultrastructures in biological samples by single-molecule active control microscopy (SMACM). Here, we present a suite of MATLAB subroutines, bundled with an easy-to-use graphical user interface (GUI), that facilitates 3D localization of single emitters (e.g. SMs, fluorescent beads, or quantum dots) with typical precisions of tens of nanometers in multi-frame movies acquired using a wide-field DH epifluorescence microscope. The algorithmic approach is based upon template matching for SM recognition and least‑squares fitting for 3D position measurement, both of which are computationally expedient and precise. Overlapping images of SMs are ignored, and the precision of least-squares fitting is not as high as maximum likelihood-based methods. Version 2.0 of Easy-DHPSF augments the approach of Version 1.0 by incorporating code that facilitates combining localization data from two spectral channels using a locally-weighted quadratic 3D registration function.&nbsp;</p><br>Keywords: Super-resolution, superresolution, localization microscopy, single molecule, fluorescence, PALM, STORM, fPALM, SMACM, double helix, DHPSF, easy-dhpsf, three-dimensional imaging, 3D, template matching, image correlation, nonlinear least-squares, wavelet, local transformation, MATLAB, graphical user interface, GUI, open source<br><h2>Introduction</h2><p>Three-dimensional localization of single emitters for super-resolution imaging and single-particle tracking continues to be a vibrant field of study<sup>1</sup>. The double-helix microscope<sup>2</sup> provides 3D information from 2D images using PSF engineering to generate images of single emitters which have two lobes, where the z-position information is contained in the angle between the two lobes. The Easy-DHPSF software provides an easy-to-use set of MATLAB programs for analysis of the “Double-Helix PSF” data generated from this kind of microscope, and with minor changes, can be adapted to other PSFs which use lobe arrangement to encode position<sup>3</sup>.</p><p><br></p><p><u>Overview of version 2.0 update</u></p><p>Easy-DHPSF version 2.0 utilizes the same algorithm for identification of SMs in a DH microscope image as version 1.0: template matching in each region of interest via phase correlation, then double-Gaussian fitting of the DHPSF<sup>4</sup> (here called DH for brevity) images through non-linear least squares minimization (<strong>Figure 1</strong>). This algorithm represents a good compromise between fitting accuracy and computational complexity. For a more detailed description of this algorithm, the reader should consult the documentation for Easy-DHPSF v1.0<sup>5</sup> as the basic details will not be repeated here. Version 2.0 introduces functions for two-color registration and for defining the calibration curves from many points, such as in a regularly-spaced nanohole array (NHA)<sup>6</sup>.</p><p><br></p><p><u>Registration of two color channels with a locally-weighted quadratic transform</u></p><p>One key aspect in most two-color wide-field imaging experiments is the procedure used to quantitatively map one channel onto the other to provide one consistent coordinate system. Simple implementations have used affine transforms or other global mapping approaches. Although global mapping functions have the advantage that they can be estimated from only a few corresponding control point pairs, they may not be flexible enough to accurately register high-resolution SM localization data. An accurate mapping function defined over the entire 3D field of view is essential for wide-field high-resolution microscopy.</p><p>The mapping function implemented in Easy-DHPSF v2.0 is a 3D locally-weighted quadratic transformation. The mapping function <strong>t </strong>transforms points from one coordinate system into another<sup>7</sup>, <strong>t(x)=x’</strong>. For coordinate transformations in 3D, <strong>t(x)</strong> has 3 components, <em>t</em><sub><em>x’</em></sub>, <em>t</em><sub><em>y’</em></sub>, and <em>t</em><sub><em>z’</em></sub>, that separately generate the three transformed coordinates <em>x’</em>, <em>y’</em>, and <em>z’</em>  (see <strong>Figure 15</strong>). The component functions <em>t</em><sub><strong>x</strong><em>’</em></sub> are given as the weighted mean of polynomial transformations <em>L</em><sub><em>i,</em><strong>x</strong><em>’</em></sub> using the local weights <em>W</em><sub><em>i </em>&nbsp;</sub>associated with control point <em>i</em> with coordinates <strong>x</strong><sub><em>i</em></sub> (see <strong>Figure 16</strong>), where the sum is over the full set of <em>N</em> control points in the image domain. </p><p>The polynomial transformation functions <em>L</em><sub><em>i,</em>x’</sub> are defined exactly for each pair of control points: i.e., <em>L</em><sub><em>i,</em><strong>x</strong>’ </sub>(<strong>x</strong><sub><em>i</em></sub>) = <strong>x</strong><sub><em>i</em></sub>’ without error. The <em>x’</em> component of a 3D quadratic transformation is given by the equation below, and <em>y’</em> and <em>z’</em> components are similarly defined (see<strong> Figure 17</strong>).</p><p>The functions <em>L</em><sub><em>i,</em><strong>x</strong>’</sub> are sufficient to define the map between the control points, i.e. the points <strong>x</strong><sub><em>i</em></sub> and <strong>x</strong><sub><em>i</em></sub>’, while the weighting coefficients <em>W</em><sub><em>i</em></sub> are used to interpolate between these points. The weight associated with control point <em>i</em> is given as a 3D Gaussian sphere centered at <strong>x</strong><sub><em>i</em></sub>. The width of the Gaussian sphere is defined by a global width parameter <em>s</em>, and a local width parameter <em>σ</em><sub><em>i</em></sub> that varies from point to point to accommodate the local density of control points (see <strong>Figure 18</strong>).</p><p>For the automated computation of the complete transformation function, the user needs to specify three parameters: the number of neighboring control points <em>n</em> used to calculate the coefficients of the polynomial transformation by least squares estimation, the global width parameter <em>s</em>, and the generating function used to define <em>σ</em><sub><em>i</em></sub>. These three parameters are systematically determined by the optimization program for each set of control point pairs to produce the lowest overall registration errors as described below in Step 8. The design of the registration algorithm is discussed further in Ref. 7.</p><p>Below, we demonstrate the use of open-source Easy-DHPSF v2.0 by analyzing an SM dataset of microtubules immunolabeled with blinking Alexa647 (Life Technologies) and CF568 (Biotium) in BSC-1 cells. This code has been validated in several different imaging conditions (Refs. 6, 8, 9) and is provided free-of-charge under the 3-clause New BSD License at <a href="https://opensource.org/licenses/BSD-3-Clause" target="_blank"><u>https://opensource.org/licenses/BSD-3-Clause</u></a><em>.</em> Specifically, this code is provided “as is” without guarantees of any kind.</p><h2>Reagents</h2><p><u>﻿</u></p><h2>Equipment</h2><p><u>Calibration and control points – beads vs. NHA</u></p><p>Calibration and control-point scans can be performed with either fluorescent beads immobilized on a coverslip <sup>8</sup> or with a metal nanohole array (NHA) filled with a solution containing the fluorophore labels of interest<sup>6</sup>. Whereas use of beads on a coverslip allows for faster fitting and generation of the transformation function, the NHA provides finer sampling of the field of view. This allows both the DH calibration and two-color registration function to account for field-dependent errors arising from aberrations in the imaging system. Moreover, by scanning the NHA laterally, we can sample the field of view in a finer and more controllable way than with beads randomly dispersed onto a coverslip.</p><p>Below, to generate the set of control points used to calculate the registration function, we imaged bright fluorescent beads (200 nm Tetraspeck, Invitrogen) dispersed on a coverslip with emission simultaneously visible in both detection channels. We repeatedly scanned the positions of beads throughout a 3D field of view to assemble a large set of control point pairs to finely calibrate the spatial differences in DH response at many locations in the two color channels. A similar procedure of axial and lateral scanning of a fluorophore-filled NHA can also be performed.&nbsp;</p><p><br></p><p><u>Software</u></p><p>The Easy-DHPSF package consists of MATLAB functions and subroutines and requires the image processing, optimization, statistics, and wavelet toolboxes. Easy-DHPSF has been tested on workstations running MATLAB 2017b. There are no known issues with earlier versions of MATLAB, but some built-in functions (e.g. fft2, imread) may have reduced performance in earlier versions.</p><p><br></p><p><u>Data file considerations </u></p><p>Easy-DHPSF v2.0 requires several .tif stacks to run.</p><p>The first image stacks are the raw data file(s) of the two color channels with SMs to be localized. If desired, the field of view may contain one or more fiducials to correct for sample drift, ideally located near the edge of the field of view and not overlapping with the region containing single molecules to be localized. The two-color imaging may be performed on a standard two-color SM microscope with each color channel imaged on separate cameras, or the two color channels may be imaged onto different regions of the same camera.</p><p>The second image stack is a calibration scan. This should comprise a series of frames at different <em>z</em>-positions of either beads on a coverslip or a NHA that are detected in both color channels simultaneously. As an example: The calibration scan is taken by translating the piezoelectric <em>z</em> stage in 50 nm steps from -1 micron to +1 micron relative to the focus (with ~20 acquired frames at each step to improve precision of the measurement), ensuring that there are enough frames between each step to allow for relaxation of the stage or oil and the sample. A sequence log file should be generated with the sequence of steps used to generate this calibration scan. An example sequence log file for this calibration step is provided (sequenceLog_calibrationScan.dat).</p><p>The third image stack is a control point scan. The control point scan is taken by translating the <em>z</em> stage in known step sizes across the range of the DHPSF, i.e., 200 nm steps from -1 micron to +1 micron, with multiple frames (~20) at each step to improve precision. After each complete axial scan, the stage is then translated laterally and the axial scan is repeated to ensure fine sampling of the field of view. The user should ensure that the relative brightness of the DHPSFs are similar in both color channels. The user should also ensure that this scan is taken with the same filters as those used for SM data. A sequence log file should be generated with the sequence of steps used to generate this calibration scan. An example sequence log for this control point scan step is provided (sequenceLog_controlPointScan.dat).</p><p>The last image stacks are ‘dark offsets’ for the calibration and the data files. The frames in the dark offset .tif stacks are averaged and subtracted before data processing to account for the offset and dark counts from the EMCCD. Acquire a series of a few hundred frames with the camera shutters closed, and use the same acquisition parameters (e.g. integration time, EM gain, shift speed) as those used for the calibration and data acquisition. If these parameters are the same between the calibration and raw data images, only one dark offset file is necessary.</p><h2>Procedure</h2><p><u>Step 0. Image acquisition and program setup</u></p><p>Acquire the raw data, calibration scan, control point scan, and dark offset images described in Equipment. Ensure that you have saved a sequence log file for the calibration and control point scans.</p><p><br></p><p><u>Step 1. Two-color DHPSF calibrations</u></p><p>This section will outline the steps to perform two-color calibrations of the DHPSF either with beads or with a NHA.</p><p>1.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open an instance of the Easy-DHPSF GUI by entering ‘easy_dhpsf’ in the MATLAB command line.</p><p>1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Before running any of the modules, set the conversion gain and pixel size of the detector using the fields under ‘Setup.’ Note that changing these parameters after processing the data does not retroactively change the calculated results (<strong>Figure 2</strong>).</p><p>1.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Under Setup &gt; Channel, select a channel ‘G’ for green or ‘R’ for red.</p><p>1.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Under ‘Calibrate DHPSF’, click ‘Run.’</p><p>1.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Follow the prompts if you would like to automatically save the partly processed dataset after this module.</p><p>1.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open the calibration images file, the dark offset image file matching the calibration, and the sequence log file (either .mat or .dat) for the calibration. The program will prompt you for these files via dialog boxes.</p><p>1.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set the EM gain used during the acquisition of the calibration images, whether you would like use wavelet subtraction, NHA holes if using NHA and whether the holes are at 45 degrees, whether the DHPSF’s two lobes are horizontal when in focus, and the box radius for fitting.</p><p>1.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a region of interest to analyze. Follow 1.8.1 if using beads on a coverslip, or 1.8.2 if using an NHA.</p><p>1.8.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a region of interest (ROI) containing at least one bright fluorescent object by adjusting the box and double-clicking inside it. Even though the calibration bead may be isolated, it is helpful to select an entire wide-field excitation region so that the background fluorescence can be estimated accurately. Select fluorescent objects by clicking the center of each DHPSF (<strong>Figure 3</strong>).</p><p>1.8.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select an ROI by adjusting the box and double-clicking inside it. Select 4 holes that form a large square, then select fiducials to outline the edge of your field of view (<strong>Figure 4</strong>). Make sure to try to click the center of each DHPSF, halfway between the two lobes. Hit enter when finished DHPSFs.</p><p>1.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each frame of raw data, as well as the accompanying double Gaussian fit, is displayed as it is processed.</p><p>1.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;After processing, an output of calibration information will be generated in the ‘calibration [DateAndTime]’ folder. Inspect this for each bead to ensure that the angle vs. <em>z</em> position curve is roughly linear, and that the variation of angle measurements in each step is not unreasonably high (error bars in upper-left plot) (see <strong>Figure 5</strong> below). Additional information from the calibration, such as the observed shift in <em>x</em> and <em>y</em> position with axial position or wobble, may be useful when aligning the DH phase mask.</p><p>1.11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select the most reliable calibration bead in the Easy-DHPSF main window using the drop-down menu. The calibration information and templates generated from this bead will be used in all later processing steps.</p><p>1.12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Go back to step 1.2 and repeat the calibration process for the other color channel. When done, click the save icon (located on the top left of the window) to save your calibrations. You can open this calibration file for use in the subsequent steps.</p><p><br></p><p><u>Step 2. Single-molecule detection calibration for SMACM data</u></p><p>In this module, the templates generated from the calibration subroutine are used to generate a large array of matches to the raw SMACM image data. This step serves to assess what value of phase correlation is typical for a good match to an SM image. After this step, the user will define a threshold for each template such that only DHPSF images of reasonable quality will be analyzed with the double-Gaussian fitting algorithm.</p><p>2.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Under Setup &gt; Channel, select a channel ‘G’ for green or ‘R’ for red.</p><p>2.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Click the ‘Run’ button in the ‘Calibrate SM identification’ panel.</p><p>2.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Follow the prompts if you would like to automatically save the GUI after this module.</p><p>2.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set the EM gain used, load in the SM data .tif file(s), select what frames to perform the SM detection calibration on, and select the templates to be used. By default, templates are chosen by the program such that the angle of the line connecting the two lobes is given by {-60°, -30°, 0°, 30°, 60°, 90°}, and this selection should generally be appropriate (<strong>Figure 6</strong>).</p><p>2.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the dark offset .tif file with the same parameters as the SM data.</p><p>2.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The program will then prompt the user to choose a background processing algorithm such as median filtering, wavelet filtering, no background subtraction, or select if the data is an NHA, <strong>Figure 7</strong>. Median filtering parameters should be filled in if choosing this option.</p><p>2.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a region containing the SMs of interest. This exact ROI will be used for the single-molecule fitting module and ideally should not contain fluorescent objects that are much (≥10x) brighter than the SMs you wish to analyze. Template matches are indicated as circles drawn over the raw data. Stronger matches are drawn as larger circles, and each color corresponds to a different template match.</p><p>2.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;After the template-matching module is complete, open the ’threshold [DateAndTime]’ folder. This contains a selection of .png files that represent potential template matches. The filenames describe which template matched the data and the value of the phase correlation for the match (e.g. ‘template 3 threshold 272.png’).</p><p>2.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select appropriate thresholds for each template, and enter these into the ‘threshold’ field in the GUI. These thresholds should be chosen such that the two lobes of the DHPSF are faintly visible and that there is a low rate of false matches for higher correlation values. You should not be concerned if there are a few incorrect matches, say to one lobe of the DHPSF from a very bright molecule, because these will be rejected by the subsequent double-Gaussian fit module.&nbsp;</p><p><br></p><p><u>Step 3. Fiducial tracking (optional) </u></p><p>This module tracks the movement of one or more fluorescent beads or other stationary markers. Stage drift during a SM experiment can be thus be removed by subtracting the movement of the fiducial marker from the SM localizations.</p><p>3.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Click the ‘Run’ button in the ‘Track fiduciaries’ panel.</p><p>3.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Follow the prompts if you would like to automatically save the GUI after this module.</p><p>3.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a region of interest containing at least one bright fiducial by adjusting the box and double-clicking inside it.</p><p>3.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select one or more fiducials by clicking in the center of each DHPSF.</p><p><br></p><p><u>Step 4. Single-molecule localization for SMACM data </u></p><p>Using the results of the previous processing steps, this module identifies single molecules that score above the template matching threshold identified in step 2.9, then fits them using nonlinear least squares minimization to a double-Gaussian function.</p><p>4.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Click the ‘Run’ button in the ‘Localize DHPSF SMs’ panel.</p><p>4.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Follow the prompts if you would like to automatically save the GUI after this module.</p><p>4.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choose the frames from the raw data to process, as well as whether you would like to estimate the laser profile and find true lobe widths (sigmas). By default, the entire image stack is processed.</p><p>4.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Whenever starting analysis of a new experiment, monitor this process as it proceeds to ensure that the threshold used includes the single molecules visible in the raw data, and to ensure that the fits are performed successfully. Only matches that score above the thresholds are fit, and good fits are plotted in the frame-by-frame reconstruction. Here the definition of a good double-Gaussian fit is a fit that meets several straightforward criteria, hard-coded into the module. The tests performed to define a good fit are listed below under Troubleshooting (Step 4).</p><p>4.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Save this Easy-DHPSF file using the save icon at the top of the GUI, ensuring that the Channel selected is the correct one.</p><p>4.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Go back to Step 2, this time selecting the other color channel.</p><p>4.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ensure that you have two saved easy-dhpsf files, one for each color.</p><p><br></p><p><u>Step 5. Single-molecule detection calibration for control points </u></p><p>5.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the Easy-DHPSF GUI file from Step 1, saved after calibrating both the green and red channels.</p><p>5.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Under Setup &gt; Channel, select a channel ‘G’ for green or ‘R’ for red.</p><p>5.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Click ‘Run’ in the ‘Calibrate SM identification’ panel.</p><p>5.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Follow the prompts if you would like to automatically save the GUI after this module.</p><p>5.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set the EM Gain used, load in the control point scan .tif file(s), select what frames to perform the control point detection calibration on, and select the templates to be used. A subset of the frames may be used, but ensure that the frames you selected are ones that include at least 1-2 full axial scans so that different <em>z</em> positions are included in the calibration.</p><p>5.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the sequence log file (.dat or .mat) with the sequence of steps used for the control point scan.</p><p>5.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in dark offset .tif with the same parameters as the control point scan.</p><p>5.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The program will then prompt the user to choose background median filtering, wavelet filtering, no background subtraction, or select if the data is a NHA array. Median filtering parameters should be filled in if choosing this option. If an NHA is used, select NHA so that the program will fit localizations found in a grid – this will increase the number of PSFs detected. If NHA is selected, median background subtraction is performed.</p><p>5.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A frame of the scan will pop up, and the user will be prompted to select an ROI of the correct color channel using a square ROI. The user will then be able to select an ROI with a polygon.</p><p>5.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;After the calibration, follow Steps 2.4-2.5 described above for selecting thresholds.</p><p><br></p><p><u>Step 6. Single-molecule localization for control points</u></p><p>This will outline the steps to fit control points in the two channels.</p><p>6.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Click the ‘Run’ button in the ‘Localize DHPSF SMs’ panel.</p><p>6.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choose the frames you would like to fit, as well as whether you would like to estimate the laser profile and find true lobe sigmas.</p><p>6.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;As this step is for fitting the control points, enter how many stationary frames there are for each axial position and click ‘OK.’</p><p>6.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If using an NHA, select 4 fiducials that form a box that outlines the field of view (<strong>Figure 8</strong>). The program will find the rest of the DHPSFs located on a grid for each axial scan. Otherwise, this step does not show up for bead fitting (<strong>Figure 9</strong>).</p><p>6.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Once the program is finished fitting, filter and export your results. Under ‘Output DHPSF SM localization’, click ‘Filter Output.’</p><p>6.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If using a NHA, choose ‘Yes’ when the program asks whether you would like to use spatially dependent calibrations. Doing this will reduce field-dependent aberrations by applying nearest-neighbor calibrations to your data with the NHA.</p><p>6.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A different calibration may be used during this step. The program will prompt the user with this option.</p><p>6.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter your control points as prompted by the program (for instance, filter by frame, <em>z</em> position, lobe distance, photons, localization precision, etc.).</p><p>6.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choose the region to be plotted in the scatter plot, inspect the localizations, then save your data when you are happy with the results. The filtered localizations will be in the file ‘Output.mat’, for use in the next step.</p><p>6.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Repeat steps 5 and 6 for the other color channel. Take note of where you saved the filtered output files, as they will be needed for the next step.</p><p><br></p><p><u>Step 7. Identification of control points</u></p><p>This module will identify candidate control points between two channels.</p><p>KEY INPUTS: Output.mat file of GREEN and RED channels</p><p>KEY OUTPUTS: Identify_ControlPoints_3D_output.mat</p><p>7.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Run the MATLAB function ‘Identify_ControlPoints_3D_v1.m’</p><p>7.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open the ‘Output.mat’ data file with the molecule fits in reflected/GREEN channel. (If you are not using a single camera, ignore “reflected” vs. “transmitted”.)</p><p>7.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open the ‘Output.mat’ data file with the molecule fits in transmitted/RED channel.</p><p>7.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open the .mat or .dat sequence log file for the control point scan.</p><p>7.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If available, open a previous transform to use as an initial guess. Otherwise, click ‘Cancel’</p><p>7.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Input parameters of how many stationary frames were taken at each <em>z</em> position, how many frames to wait before starting the averaging, and if using an old transform, how closely the initial transform should match old transform points. The program will prompt you for these values.</p><p>7.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The program will first find control point (CP) candidates, merging localizations at given <em>z</em> positions.</p><p>7.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A figure will pop up with fitting statistics for the molecules fits you loaded. Enter filtering parameters for <em>σ</em><sub><em>x</em></sub>,<sub> </sub><em>σ</em><sub><em>y</em></sub>, <em>σ</em><sub><em>z</em></sub>, and number of measurements.</p><p>7.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inspect averaged bead positions in both channels.</p><p>7.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If an initial transform was not given in step 3.5, the program will ask you to hand click control points. Aim to hand click at least ~15 control points. Follow the prompts in the figure (<strong>Figure 10</strong>, <strong>Figure 11</strong>). Both the color and size of each localization encodes the relative brightness (number of photons detected) of that molecule. If the program is still prompting you to select control points but you have already selected &gt;15 and would like to stop, get a new frame then hit ‘esc’ to end.</p><p>7.11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When finished hand clicking control points, the program will run and generate a preliminary transformation file that you will use for the next step. This file will be located in the same directory where your green channel ‘Output.mat’ is saved.</p><p><br></p><p><u>Step 8. Generating and evaluating final 3D transform from control points</u></p><p>This module will evaluate the initial transform calculated in Step 7 above and generate a final transform you can use in the next step.</p><p>KEY INPUTS: Identify_ControlPoints_3D_output.mat</p><p>KEY OUTPUTS: 3D_Transform_lwquadratic.mat</p><p>8.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Run the MATLAB function ‘EvaluateTransform_3D_v2.m’</p><p>8.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Input transformation parameters (then proceed to Step 8.4) or click if you want to evaluate parameter ranges (proceed to Step 8.3).</p><p>8.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Enter the range of parameters you would like to evaluate. The program will evaluate these parameter ranges then return the calculated target registration errors (TRE) and fiducial registration errors (FRE)<sup>9</sup>. An example result is in <strong>Figure 12</strong>. Inspect the results by clicking on the figure. Ideally, the user should aim for errors ≤ 10 nm.</p><p>8.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select the value of nearest neighbors, sigma, and kth nearest neighbor, and input these parameters into the dialog box that appears. The program will then calculate a transformation using the parameters you provided. For the ~1000 control point pairs in the example here, the mapping function took ~1 hour to generate using an Intel Xeon E5-1620 processor.</p><p>8.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The program will return a histogram of TREs and FREs, as well as the spatial distribution of these metrics. The final transformation is ‘3D_Transform_lwquadratic.mat’ and will be located in the same folder as ‘Identify_ControlPoints_3D_output.mat.’</p><p><br></p><p><u>Step 9. Transforming SMACM data</u></p><p>This module will smooth the fiducial tracks, perform the 3D two-color registration, correct for sample drift, apply an index mismatch correction, and calculate localization precision.</p><p>KEY INPUTS: Easy-DHPSF files for each of the two color channels, transformation function (3D_Transform_lwquadratic.mat)</p><p>KEY OUTPUTS: MATLAB structure called dataSets</p><p>9.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Run the MATLAB script ‘TransformSMACMData_v6.m’</p><p>9.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indicate whether the green data or red data was acquired first, or if the two-color acquisition was interleaved.</p><p>9.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the green Easy-DHPSF file. The program will perform smoothing via wavelet filtering of the fiducial tracks and apply this correction to your data. Follow the prompts that appear.</p><p>9.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the red Easy-DHPSF file, and follow prompts that appear to smooth fiducial track data.</p><p>9.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Load in the ‘3D_Transform_lwquadratic.mat’ file generated in the previous step.</p><p>9.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The program will prompt whether or not you would like to crop each dataset before the transformation.</p><p>9.7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select the location and enter a file name for where to save your registered dataset.</p><p>9.8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The registered data is stored in the MATLAB structure ‘dataSets,’ with ‘dataSets(1)’ containing the green data and ‘dataSets(2)’ containing the red data. The fields xFid, yFid, and zFid_n contain the fiducial-corrected and index-corrected localizations. The rest of the fields are described in <strong>Figure 19</strong>.</p><p>9.9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select whether you would like to export the localizations into a csv file. If yes, choose the location and file name of each color file.</p><h2>Anticipated Results</h2><p>Below is a 2D scatterplot of Alexa647- and CF568-immunolabeled tubulin in a BSC-1 cell as measured by SMACM blinking of the labels (<strong>Figure 13</strong>). Both colors are labeling the same structure which contains microtubules in a thin region of the cell. Note that this 2D scatterplot representation of 3D data is quick to render for inspection purposes but does not show depth (<em>z</em>) or density, overemphasizing sparse regions of the sample and often appearing noisier than a density plot. To avoid misinterpreting results, we strongly recommend exporting your two-color localizations to a different program for better visualization with a more reasonable reconstruction, such as that shown in <strong>Figure 14</strong>.</p><h2>References</h2><p>1. A. von Diezmann, Y. Shechtman and W. E. Moerner, <em>Chem. Rev</em>. 117, 7244 (2017). </p><p>2. M. A. Thompson, Matthew D. Lew, M. Badieirostami and W. E. Moerner, <em>Nano Lett</em>. 10, 211 (2010). </p><p>3. A. S. Backer, M. P. Backlund, A. R. von Diezmann, S. J. Sahl and W. E. Moerner, <em>Appl. Phys. Lett.</em> 104, 193701 (2014). </p><p>4. S. R. P. Pavani, M. A. Thompson, J. S. Biteen, S. J. Lord, N. Liu, R. J. Twieg, R. Piestun and W. E. Moerner, <em>Proc. Natl. Acad. Sci. U. S. A</em>. 106, 2995 (2009). </p><p>5. Matthew D. Lew, Alexander R. S. von Diezmann and W. E. Moerner, <em>Protocol Exchange</em> 026 (2013). </p><p>6. Alex von Diezmann, Maurice Y. Lee, Matthew D. Lew and WE Moerner, <em>Optica</em> 2, 985 (2015). </p><p>7. A. A. Goshtasby, <u>Image registration, </u>(Springer-Verlag, London, 2012), p. 441. </p><p>8. Andreas Gahlmann, Jerod Louis Ptacin, Ginni Grover, Sean Quirin, Alexander R. S. von Diezmann, Marissa K. Lee, Mikael Paul Backlund, Lucy Shapiro, Rafael Piestun and W. E. Moerner, <em>Nano Lett. </em>13, 987 (2013). </p><p>9. C. A. Bayas, J. Wang, M. K. Lee, J. M. Schrader, L. Shapiro and W. E. Moerner, <em>Proc. Natl. Acad. Sci. U. S. A.</em> 115, E3712 (2018). </p><p>10. L. Stirling Churchman and James A. Spudich,<em> Cold Spring Harbor Protocols </em>2, 141 (2012).</p><h2>Acknowledgements</h2><p>We thank Joshua Yoon for his contributions to the code, and Dr. Carl G. Ebeling, Worldwide Application Scientist for Bruker Fluorescence Microscopy, for his support and for the use of the Bruker SRX visualization and analysis software for rendering localization data. This work was supported in part by the U. S. National Institute of General Medical Sciences Grant No. R35GM118067.</p></body></html>