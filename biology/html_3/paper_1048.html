<article>
<section>
<h1 id="header">Protocol for post-processing of bacterial pangenome data using Pagoo pipeline</h1>
<p><time datetime="2021-10-01">Published: October 1, 2021</time></p>
<p>Ignacio Ferrés<sup><a href="#aff1">1</a>,<a href="#aff2">2</a>,<a href="#fn1">5</a>,<a href="#cor1">*</a></sup> and Gregorio Iraola<sup><a href="#aff1">1</a>,<a href="#aff2">2</a>,<a href="#aff3">3</a>,<a href="#aff4">4</a>,<a href="#fn2">6</a>,<a href="#cor2">**</a></sup></p>
<p id="aff1"><sup>1</sup>Microbial Genomics Laboratory, Institut Pasteur Montevideo, Montevideo, Montevideo 11400, Uruguay</p>
<p id="aff2"><sup>2</sup>Center for Innovation in Epidemiological Surveillance, Institut Pasteur Montevideo, Montevideo, Montevideo 11400, Uruguay</p>
<p id="aff3"><sup>3</sup>Wellcome Sanger Institute, Hinxton, Cambridgeshire CB10 SA1, UK</p>
<p id="aff4"><sup>4</sup>Center for Integrative Biology, Universidad Mayor, Providencia, Santiago de Chile, Chile</p>
<p id="fn1"><sup>5</sup>Technical contact</p>
<p id="fn2"><sup>6</sup>Lead contact</p>
<p id="cor1"><sup>*</sup>Correspondence: <a href="mailto:iferres@pasteur.edu.uy">iferres@pasteur.edu.uy</a></p>
<p id="cor2"><sup>**</sup>Correspondence: <a href="mailto:giraola@pasteur.edu.uy">giraola@pasteur.edu.uy</a></p>
<p><span class="open-access">Open Access</span> • DOI: <a href="https://doi.org/10.1016/j.xpro.2021.100802">10.1016/j.xpro.2021.100802</a></p>
</section>
<section>
<h2 id="summary">Summary</h2>
<p>Multiple downstream analyses are necessary to interpret the output of bacterial pangenome reconstruction software. This requires integrating diverse kinds of genetic and phenotypic data, which to date are left to each user’s criterion. To fill this gap, we created Pagoo, a pangenome post-processing tool that leverages a standardized but flexible and extensible framework for data integration, analysis, and storage. Here, we provide the protocol for running Pagoo and performing from simple to more complex comparative analyses on bacterial pangenome data.</p>
<p>For complete details on the use and execution of this protocol, please refer to Ferrés and Iraola (2021).</p>




<div class="highlights">
<h3>Highlights</h3>
<ul>
<li>Bacterial pangenome analysis needs the integration of genetic and phenotypic data</li>
<li>This protocol shows how to achieve this using the Pagoo software package</li>
<li>Pagoo works in concert with other microbial genomics packages in the R ecosystem</li>
</ul>
</div>
<div class="graphical-abstract">
<h3>Graphical abstract</h3>
<figure><img src="https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1048-GA.jpg" alt="GraphicalAbstract.jpg"></figure>
</div></section>
<section>
<h2 id="before-you-begin">Before you begin</h2>
<p>Pagoo is designed to take the output generated by pangenome reconstruction software like Roary (<a href="#bib4">Page et al., 2015</a>), Panaroo (<a href="#bib7">Tonkin-Hill et al., 2020</a>), PEPPAN (<a href="#bib10">Zhou et al., 2020</a>) or panX (<a href="#bib2">Ding et al., 2018</a>). This protocol explains how to use built-in functions from Pagoo to automatically load and analyze output files produced by these pangenome reconstruction tools as they are widely used by the community. The output of any of these software tools can be loaded by Pagoo as a set of tables and genetic sequences. Hence, for starting using Pagoo, pangenome reconstruction needs to be performed on a set of genomes using any preferred tool.</p>
<h3 id="sec1.1">Pangenome reconstruction</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 30 min</div>
<p>Here, we provide a full-reproducible example on how to build a pangenome based on 168 previously published <i>Campylobacter fetus</i> genomes (<a href="#bib3">Iraola et al., 2017</a>). These genomes have been previously annotated using Prokka (<a href="#bib6">Seemann, 2014</a>) using default parameters (follow the steps described <u>here</u> to perform genome annotation). In this case, we will use Roary (<a href="#bib4">Page et al., 2015</a>) with default parameters to reconstruct the pangenome. It is assumed that Roary is installed and available in the user’s path.</p>
<ol>
<li>Download and decompress genomes from inside the R session (Box 1):</li>
</ol>
<div class="textbox">
<p><code>tar_gz &lt;- "</code><code>cfetus_pangenome.tar.gz</code><code>"</code></p>
<p><code><b>if</b> ( !file.exists(tar_gz) ) {</code></p>
<p>  <code>download.file(url = "</code><a href="https://ndownloader.figshare.com/files/26144075">https://ndownloader.figshare.com/files/26144075</a>"<code>,</code></p>
<p>  <code>destfile = tar_gz)</code></p>
<p><code>}</code></p>
<p><code>untar(tarfile = tar_gz, exdir = "</code><code>C_fetus</code><code>"</code><code>)</code></p>
</div>
<ol start="2">
<li>Run Roary to reconstruct the pangenome:
<ol type="a">
<li>List GFF annotation files and run Roary from inside the R session (Box 2):</li>
</ol>
</li>
</ol>
<div class="textbox">
<p><code>gffs &lt;- list.files(path = "</code><code>C_fetus</code><code>"</code><code>,</code></p>
<p>                    <code>pattern = "</code><code>[.]gff$</code><code>"</code><code>,</code></p>
<p>                    <code>recursive = TRUE,</code></p>
<p>                    <code>full.names = TRUE)</code></p>
<p><code>roary &lt;- paste(</code><code>"</code><code>roary -f ./C_fetus/roary_output</code><code>"</code><code>,</code></p>
<p>                <code>paste(gffs, collapse = "</code> <code>"</code><code>))</code></p>
<p><code>system(roary)</code></p>
</div>
<div class="note">
<span class="note-title">Note:</span> Timing of this step depends on the software selected to perform pangenome reconstruction and the number of genomes to be analyzed.</div>
</section>
<section>
<h2 id="key-resources-table">Key resources table</h2>
<table id="krt">
<thead>
<tr>
<th>REAGENT or RESOURCE</th>
<th>SOURCE</th>
<th>IDENTIFIER</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="3">Deposited data</td>
</tr>
<tr>
<td>GFF3 input files for pangenome reconstruction</td>
<td>Figshare</td>
<td><a href="https://doi.org/10.6084/m9.figshare.13622354.v1">https://doi.org/10.6084/m9.figshare.13622354.v1</a></td>
</tr>
<tr>
<td colspan="3">Software and algorithms</td>
</tr>
<tr>
<td>Pagoo</td>
<td><a href="#bib11">Ferrés and Iraola, 2021</a></td>
<td><a href="https://github.com/iferres/pagoo">https://github.com/iferres/pagoo</a></td>
</tr>
<tr>
<td>Roary</td>
<td><a href="#bib4">Page et al., 2015</a></td>
<td><a href="https://sanger-pathogens.github.io/Roary">https://sanger-pathogens.github.io/Roary</a></td>
</tr>
</tbody>
</table>
</section>
<section>
<h2 id="materials-and-equipment">Materials and equipment</h2>
<ul>
<li>Data (output files produced by pangenome reconstruction software - see <a href="#sec1.1">pangenome reconstruction</a> in <a href="#before-you-begin">before you begin</a>). As a working example, this protocol uses the dataset listed in the <a href="#key-resources-table">key resources table</a>.</li>
<li>Pagoo works in Linux, Mac and Windows systems in which R is installed. This protocol was conducted on Linux (Fedora Generic release 26) and R v4.0.3 using a desktop computer with 64 GB RAM and an Intel Core i7-7700 (3.60GHz) processor.</li>
</ul>
</section>
<section>
<h2 id="step-by-step-method-details">Step-by-step method details</h2>
<h3 id="sec3.1">Step 1: Installing Pagoo</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 4 min</div>
<p>Full installation of Pagoo includes downloading the Pagoo package and resolving all its dependencies from CRAN. Alternatively, the last development version of Pagoo can be installed from GitHub.</p>
<ol>
<li>Install Pagoo from CRAN by running the following code:</li>
</ol>
<div class="textbox">
<p><code>install.packages(</code><code>"</code><code>pagoo</code><code>"</code><code>)</code></p>
</div>
<ol start="2">
<li>Alternatively, install Pagoo from GitHub by running the following code:</li>
</ol>
<div class="textbox">
<p><code><b>if</b> (!<b>require</b>(</code><code>"</code><code>devtools</code><code>"</code><code>))</code></p>
<p><code>devtools::install_github(</code><code>"</code><code>iferres/pagoo</code><code>"</code><code>)</code></p>
</div>
<h3 id="sec3.2">Step 2: Loading pangenome data from scratch</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 5 min</div>
<p>First, we provide a toy example that describes how to create Pagoo’s data structure from scratch independently of the pangenome reconstruction software that was used to generate the data. This toy dataset is included when the user installs Pagoo package.</p>
<ol start="3">
<li>
<b>Generate a Pagoo object.</b> To generate a Pagoo object, the only mandatory data structure is a data.frame with information relating organisms to genes to orthologous clusters. Other optional data can be also added as additional columns or tables. Load toy example files by running the code in Box 3:
<div class="textbox">
<p><code><b>library</b>(pagoo)</code></p>
<p><code>tgz &lt;- system.file(</code><code>"</code><code>extdata</code><code>"</code><code>, "</code><code>toy_data.tar.gz</code><code>", package = "</code><code>pagoo</code><code>"</code><code>)</code></p>
<p><code>untar(tarfile = tgz, exdir = "</code><code>.</code><code>"</code><code>)</code></p>
<p><code>files &lt;- list.files(full.names = TRUE, pattern = "</code><code>tsv$|fasta$</code><code>"</code><code>)</code></p>
</div>
<ol type="a">
<li>We will see the case_df.tsv file that is the mandatory data.frame. Run the code in Box 4 to load and inspect it:
<div class="textbox">
<p><code>data_file &lt;- grep(</code><code>"</code><code>case_df.tsv</code><code>"</code><code>, files, value = TRUE)</code></p>
<p><code>data &lt;- read.table(data_file, header = TRUE,</code></p>
<p>          <code>sep = "</code><code>\t</code><code>"</code><code>, quote = "</code><code>"</code><code>)</code></p>
<p><code>head(data)</code></p>
<p><code>##        gene        org cluster                                annot</code></p>
<p><code>## 1  gene081  organismA  OG001  Thioesterase superfamily protein</code></p>
<p><code>## 2  gene122  organismB  OG001          Thioesterase superfamily</code></p>
<p><code>## 3  gene299  organismC  OG001  Thioesterase superfamily protein</code></p>
<p><code>## 4  gene186  organismD  OG001  Thioesterase superfamily protein</code></p>
<p><code>## 5  gene076  organismE  OG001          Thioesterase superfamily</code></p>
<p><code>## 6  gene352  organismA  OG002  Inherit from proNOG: Thioesterase</code></p>
</div>
</li>
<li>The first column in this file identifies each gene, the second column identifies the organism to which each gene belongs and the third column shows the orthologous cluster to which each gene was assigned in the pangenome reconstruction. The fourth column shows the annotation of each gene (optional as other additional metadata columns that can be added to this table). With only this data you can start working with Pagoo as follows:</li>
</ol>
</li>
</ol>
<div class="textbox">
<p><code>p &lt;- pagoo(data = data)</code></p>
</div>
<ol start="4">
<li>
<b>Adding metadata to organisms.</b> Relevant data associated to each organism (i.e., geographic origin, collection date, phenotyping, etc.) can be added to the basic pangenome structure as detailed in Box 5:</li>
</ol>
<div class="textbox">
<p><code>orgs_file &lt;- grep(</code><code>"</code><code>case_orgs_meta.tsv</code><code>"</code><code>, files, value = TRUE)</code></p>
<p><code>orgs_meta &lt;- read.table(orgs_file, header = TRUE,</code></p>
<p>                            <code>sep = "</code><code>\</code><code>t</code>"<code>, quote = "</code><code>"</code><code>)</code></p>
<p><code>head(orgs_meta)</code></p>
<p><code>##           org sero    country</code></p>
<p><code>## 1  organismA    a    Westeros</code></p>
<p><code>## 2  organismB    b    Westeros</code></p>
<p><code>## 3  organismC    c    Westeros</code></p>
<p><code>## 4  organismD    a      Essos</code></p>
<p><code>## 5  organismE    b      Essos</code></p>
</div>
<div class="critical">
<span class="critical-title">Critical:</span> Beware that organism names provided in orgs_meta$org must coincide with names provided in the data$org field, in order to correctly map each variable.</div>
<div class="note">
<span class="note-title">Note:</span> If partial metadata is available, for example host data is only available for a subset of organisms, fields with missing data will be automatically filled with NAs.</div>
<ol start="5">
<li>
<b>Adding metadata to orthologous clusters.</b> Relevant data can be also incorporated to each orthologous cluster, for example its functional annotation as detailed in Box 6 (see <u>here</u> for a guide for generating functional annnotations using the eggNOG database and related tools):</li>
</ol>
<div class="textbox">
<p><code>clust_file &lt;- grep(</code><code>"</code><code>case_clusters_meta.tsv</code><code>"</code><code>, files, value = TRUE)</code></p>
<p><code>clust_meta &lt;- read.table(clust_file, header = TRUE,</code></p>
<p>                            <code>sep = "</code><code>\t</code><code>"</code><code>, quote = "</code><code>"</code><code>)</code></p>
<p><code>head(clust_meta)</code></p>
<p><code>##     cluster    kegg    cog</code></p>
<p><code>## 1    OG001    &lt;NA&gt;      S</code></p>
<p><code>## 2    OG002    &lt;NA&gt;      S</code></p>
<p><code>## 3    OG003    &lt;NA&gt;  &lt;NA&gt;</code></p>
<p><code>## 4    OG004    &lt;NA&gt;      D</code></p>
<p><code>## 5    OG005    K01990    V</code></p>
<p><code>## 6    OG006    &lt;NA&gt;      V</code></p>
</div>
<div class="critical">
<span class="critical-title">Critical:</span> Again, the column clust_meta$cluster must contain the same identifiers as the data$cluster column to be able to map one into the other.</div>
<ol start="6">
<li>
<b>Adding sequences.</b> If the user wants to add sequences, these must be provided for all organisms in the dataset. The type of data needed are multi-FASTA files where each individual sequence represents a gene whose name can be mapped to the data$gene column. Sequences need to be loaded as a list where each element is named with an organism name that maps to data$org and org_meta$org. This can be done as described in Box 7:</li>
</ol>
<div class="textbox">
<p><code>fasta_files &lt;- grep(</code><code>"</code><code>[.]fasta</code><code>"</code><code>, files, value = TRUE)</code></p>
<p><code>names(fasta_files) &lt;- sub(</code><code>"</code><code>[.]fasta</code><code>"</code><code>, "", basename(fasta_files))</code></p>
<p><code><b>library</b>(Biostrings)</code></p>
<p><code>sq &lt;- lapply(fasta_files, readDNAStringSet)</code></p>
<p><code># Names are the same as in data$org</code></p>
<p><code>## [1] "organismA" "organismB" "organismC" "organismD" "organismE"</code></p>
</div>
<div class="note">
<span class="note-title">Note:</span> Pagoo currently supports the incorporation of DNA sequences. However, once sequences are incorporated into the Pagoo object, these can be translated and used as protein sequences for downstream analysis using Biostrings and other R packages.</div>
<ol start="7">
<li>
<b>Generate an object with multiple data.</b> Now, we can set up a Pagoo object integrating all this data, including presence/absence of each orthologous cluster in each organism, gene annotations, functional annotations, organisms metadata and sequences. To build the Pagoo object run the code in Box 8:</li>
</ol>
<div class="textbox">
<p><code>p &lt;- pagoo(data = data, # Required data</code></p>
<p>            <code>org_meta = orgs_meta, # Organisms metadata</code></p>
<p>            <code>cluster_meta = clust_meta, # Clusters metadata</code></p>
<p>            <code>sequences = sq) # Sequences</code></p>
</div>
<ol start="8">
<li>
<b>Adding more metadata after creating the Pagoo object.</b> The user can add new metadata as the outcome of downstream analysis or experiments. This can be achieved by adding new metadata columns either to each gene, cluster or organism defined in the Pagoo object. By running the following code, we illustrate how to add a new column to the $organisms field named host that describes the host where each organism was isolated from (see Box 9):</li>
</ol>
<div class="textbox">
<p><code>host_df &lt;- data.frame(org = p$organisms$org,</code></p>
<p>                        <code>host = c(</code><code>"</code><code>Cow</code><code>"</code><code>, "</code><code>Dog</code><code>"</code><code>, "</code><code>Cat</code><code>"</code><code>, "</code><code>Cow</code><code>"</code><code>, "</code><code>Sheep</code><code>"</code><code>))</code></p>
<p><code>p$add_metadata(map = "</code><code>org</code><code>"</code><code>, host_df)</code></p>
<p><code>p$organisms</code></p>
<p><code>##          org    sero    country      host</code></p>
<p><code>## 1  organismA        a  Westeros      Cow</code></p>
<p><code>## 2  organismB        b  Westeros      Dog</code></p>
<p><code>## 3  organismC        c  Westeros      Cat</code></p>
<p><code>## 4  organismD        a      Essos      Cow</code></p>
<p><code>## 5  organismE        b      Essos    Sheep</code></p>
</div>
<div class="critical">
<span class="critical-title">Critical:</span> To allow Pagoo to correctly map the data, values in the first column of the host_df table must be the same as in p$organisms$org, and its column header must also be named org.</div>
<div class="note">
<span class="note-title">Note:</span> Preparing data from scratch and loading classes can be relatively laborious, but in real life working datasets this will be rarely needed. To avoid this, Pagoo provides helper functions that directly parse and read-in output files produced by most widely-used pangenome reconstruction software, avoiding any formatting or manipulation of data (see <u>next step</u>).</div>
<h3 id="sec3.3">Step 3: Input from pangenome reconstruction software</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 10 min</div>
<p>Pagoo allows read-in output files produced by most widely-used pangenome reconstruction software. Since its publication in 2015, Roary (<a href="#bib4">Page et al., 2015</a>) has been the standard and most cited software for pangenome reconstruction. More recently, other related software have emerged like PIRATE (<a href="#bib1">Bayliss et al., 2019</a>), Panaroo (<a href="#bib7">Tonkin-Hill et al., 2020</a>) and PEPPAN (<a href="#bib10">Zhou et al., 2020</a>) that improved different steps of pangenome reconstruction or provided new analytical approaches. Also, we have created our own pangenome reconstruction software called Pewit (unpublished but available at <a href="https://github.com/iferres/pewit">https://github.com/iferres/pewit</a>), which automatically generates a Pagoo-like object to perform downstream analyses. This object contains all the methods and fields that Pagoo provides, but adding a set of methods and fields exclusive to Pewit (not covered in this protocol). Here, we provide full details on how to load output files from Roary and indicate how to load output files from other above-listed software.</p>
<ol start="9">
<li>To create a pangenome object using Pagoo from output files produced by Roary (as described in <u>step 2</u>), run the code described in Box 10 assuming you are placed in the output directory generated by Roary:</li>
</ol>
<div class="textbox">
<p><code>gffs &lt;- list.files(path = "</code><code>../gffs/</code><code>"</code><code>, pattern = "</code><code>[.]gff$</code><code>"</code><code>, full.names = TRUE)</code></p>
<p><code>gpa_csv &lt;- "</code><code>gene_presence_absence.csv</code><code>"</code></p>
<p><code><b>library</b>(pagoo)</code></p>
<p><code>p &lt;- roary_2_pagoo(gene_presence_absence_csv = gpa_csv, gffs = gffs)</code></p>
</div>
<div class="note">
<span class="note-title">Note:</span> Exactly the same approach can be used to load output files from Panaroo, by using the analogous function panaroo_2_pagoo(). Other software like PIRATE and PEPPAN provide scripts (PIRATE_to_roary.pl and PEPPAN_parse.py, respectively) that transform their output files into Roary’s output format. Then, roary_2_pagoo() function can be used to generate the pangenome object from PIRATE and PEPPAN once this transformation has been applied.</div>
<h3 id="sec3.4">Step 4: Querying pangenome data</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 10 min</div>
<p>The user can easily explore information that is stored inside the Pagoo object using standard R notation. Indeed, this object has its own associated data and methods that can be easily queried with the '$' operator. These methods allow for the rapid subsetting, extraction and visualization of pangenome data.</p>
<ol start="10">
<li>
<b>Summary statistics.</b> A pangenome can be stratified in different gene subsets according to their frequency. The core genes are defined as those present in every genome (also the term soft core is typically used for genes occurring in 95%–100% of genomes). The remaining genes are defined as the accessory genome, that can be subdivided in cloud genes or singletons (present in only one genome or only in genomes that) and shell genes which are those in the middle. Run the following code in Box 11 to see this:</li>
</ol>
<div class="textbox">
<p><code>p$summary_stats</code></p>
<p><code>#    Category  Number</code></p>
<p><code># 1    Total    7326</code></p>
<p><code># 2    Core    1489</code></p>
<p><code># 3    Shell    5010</code></p>
<p><code># 4    Cloud    818</code></p>
</div>
<ol start="11">
<li>
<b>Core level.</b> The core level defines the minimum number of genomes (as a percentage) in which a certain gene should be present to be considered a core gene. By default, Pagoo considers as core genes all those present in at least 95% of organisms. The core level can be modified to be more or less stringent defining the core genome. Modifying the core level will affect the pangenome object state resulting in different core, shell and cloud sets. See this running the command in Box 12:</li>
</ol>
<div class="textbox">
<p><code>p$core_level # [1] 95</code></p>
<p><code>p$core_level &lt;- 100 # Change value</code></p>
<p><code>p$summary_stats # Updated object</code></p>
<p><code>#    Category    Number</code></p>
<p><code># 1      Total      7326</code></p>
<p><code># 2      Core      1117</code></p>
<p><code># 3      Shell      5391</code></p>
<p><code># 4      Cloud        818</code></p>
</div>
<ol start="12">
<li>
<b>Pangenome matrix.</b> The pangenome matrix is one of the most useful things when analyzing pangenomes. Typically, it represents organisms in rows and clusters of orthologous genes in columns informing about gene abundance (considering paralogues). The pangenome matrix looks like the one shown in Box 13 (printing only first 5 rows and columns):</li>
</ol>
<div class="textbox">
<p><code>p$pan_matrix[1:5, 1:5]</code></p>
<p><code>#               aadK   aaeA_1   aaeA_2   aat   aat_2</code></p>
<p><code># 16244_6#1      1        0        0    1      0</code></p>
<p><code># 16244_6#10    0        0        0    1      0</code></p>
<p><code># 16244_6#11    1        0        0    1      0</code></p>
<p><code># 16244_6#12    0        0        0    1      0</code></p>
<p><code># 16244_6#13    1        0        0    1      0</code></p>
</div>
<ol start="13">
<li>
<b>Genes metadata.</b> Metadata associated with each individual gene can be accessed by the $genes suffix. It always contains the gene name, the organism to which it belongs, its assigned cluster and a gene identifier (gid). Optionally, it can typically include annotation data, genomic coordinates, etc. Gene metadata is splitted by cluster, so it consists of a list of dataframes (Box 14, showing only the first rows):</li>
</ol>
<div class="textbox">
<p><code>p$genes[1]</code></p>
<p><code># SplitDataFrameList of length 1</code></p>
<p><code># $aadK</code></p>
<p><code># DataFrame with 7 rows and 10 columns</code></p>
<p><code>#</code>                      <code>cluster           org                 gene</code>                      <code>gid</code></p>
<p><code>#</code>                      <code>&lt;factor&gt;    &lt;factor&gt;            &lt;factor&gt;            &lt;character&gt;</code></p>
<p><code># 16244_6#1_00636      aadK    16244_6#1    16244_61_00636    16244_6#1__16244_6..</code></p>
<p><code># 16244_6#11_00101      aadK  16244_6#11  16244_6#11_00101  16244_6#11__16244_6..</code></p>
<p><code># 16244_6#13_00100      aadK  16244_6#13  16244_6#13_00100  16244_6#13__16244_6#..</code></p>
</div>
<ol start="14">
<li>
<b>Clusters metadata.</b> Groups of orthologous genes (clusters) are also stored in Pagoo objects as a table with a cluster identifier per row, and additional columns as optional metadata (Box 15, showing only first rows):</li>
</ol>
<div class="textbox">
<p><code>p$clusters</code></p>
<p><code># DataFrame with 7326 rows and 2 columns</code></p>
<p><code>#   cluster                Annotation</code></p>
<p><code>#&lt;factor&gt;                &lt;character&gt;</code></p>
<p><code># 1  aadK        hypothetical protein</code></p>
<p><code># 2  aaeA_1    Ribonuclease P prote..</code></p>
<p><code># 3  aaeA_2    N-carbamoyl-D-amino..</code></p>
<p><code># 4  aat        putative ABC transpo..</code></p>
<p><code># 5  aat_2      hypothetical protein</code></p>
</div>
<ol start="15">
<li>
<b>Sequences.</b> Although it is an optional field (it exists only if the user provides this data as an argument when the object is created), $sequences gives access to sequence data. Sequences are stored as a DNAStringSetList object as defined in the Biostrings package. The code in Box 16 will list all sequences in clusters (only showing first rows):</li>
</ol>
<div class="textbox">
<p><code>p$sequences</code></p>
<p><code># DNAStringSetList of length 7326</code></p>
<p><code># [["COQ2"]] 16244_6#1__16244_6#1_01627=ATGGCTAAATTTACTCAAATTTTAAAAGATATAAACGAA…</code></p>
<p><code># [["COQ3_1"]] 16244_6#1__16244_6#1_00352=ATGAGTAACGCAAACGCATGGGACGATATGTCAAATT…</code></p>
<p><code># [["COQ3_2"]] 16244_6#10__16244_6#10_01654=ATGAAAAAAACGTTTTCATTTGGAAAAAACTGGCT…</code></p>
<p><code># [["COQ3_3"]] 16244_6#1__16244_6#1_00772=ATGAAAGAAAAGTTTTTTGAACTAAAAGTTTTAAGCC...</code></p>
</div>
<p>Then, you can list all sequences of a single cluster by running the code in Box 17 (only showing first rows):</p>
<div class="textbox">
<p><code>p$sequences[[</code><code>"</code><code>aadK</code><code>"</code><code>]]</code></p>
<p><code># DNAStringSet object of length 7:</code></p>
<p><code># [1] 858 ATGAAAATGAGAACAGAGAAACA...AAAAAGAAAAATATCAAAGATAA 16244_6#1__16244_…</code></p>
<p><code># [2] 858 ATGAAAATGAGAACAGAGAAACA...AAAAAGAAAAATATCAAAGATAA 16244_6#11__16244…</code></p>
<p><code># [3] 858 ATGAAAATGAGAACAGAGAAACA...AAAAAGAAAAATATCAAAGATAA 16244_6#13__16244…</code></p>
<p><code># [4] 858 ATGAAAATGAGAACAGAGAAACA...AAAAAGAAAAATATCAAAGATAA 16244_6#6__16244_…</code></p>
</div>
<div class="critical">
<span class="critical-title">Critical:</span> Note that sequence names are created by pasting organism names and gene names, separated by a string that by default is sep = '__' (two underscores). This is the same as the gid column in the $genes field, and is initially set when a Pagoo object is created. If you think your dataset contains names with this separator, then you should set this parameter to another string to avoid conflicts.</div>
<div class="note">
<span class="note-title">Note:</span> Sequences can be written to text as multi-FASTA format files using standard methods provided by the Biostrings package.</div>
<ol start="16">
<li>
<b>Organisms metadata.</b> The $organisms field contains a table with organisms and metadata as additional columns if provided (Box 18, only showing first rows):</li>
</ol>
<div class="textbox">
<p><code>p$organisms</code></p>
<p><code># DataFrame with 168 rows and 10 columns</code></p>
<p><code>#     org      Accession.Number  Identifier    Strain    Year    Country</code></p>
<p><code>#     &lt;factor&gt;&lt;character&gt;  &lt;character&gt;  &lt;character&gt;  &lt;integer&gt;  &lt;character&gt;</code></p>
<p><code># 1  16244_6#1  ERS672242          FR10    2006/367h        2006        France</code></p>
<p><code># 2  16244_6#10  ERS672251          FR19    2008/755h        2008        France</code></p>
<p><code># 3  16244_6#11  ERS672252          FR20    2008/898h        2008        France</code></p>
<p><code># 4  16244_6#12  ERS672253          FR21    2010/41h        2010        France</code></p>
<p><code># 5  16244_6#13  ERS672254          FR22    2010/524h        2010        France</code></p>
</div>
<h3 id="sec3.5">Step 5: Data subsetting</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 10 min</div>
<p>Data subsetting is a fundamental operation when working with pangenome, enabling structured and more in depth analyses. Pagoo provides three ways of subsetting: (i) predefined subsets, (ii) classic R’s subsetting operations using square bracket operators, and (iii) removal or recovering organisms from the dataset.</p>
<ol start="17">
<li>
<b>Predefined subsets.</b> As explained in <u>step 10</u>, elements within a pangenome can be classified in different compartments given their frequency of occurrence: core, shell and cloud. Pagoo provides operators to directly access elements in these compartments, independently if they are genes, clusters or sequences. Look at the following table for all possible combinations:
<table id="undtbl1">
<thead>
<tr>
<th> </th>
<th>$core_∗</th>
<th>$shell_∗</th>
<th>$cloud_∗</th>
</tr>
</thead>
<tbody>
<tr>
<td>$∗_genes</td>
<td>$core_genes</td>
<td>$shell_genes</td>
<td>$cloud_genes</td>
</tr>
<tr>
<td>$∗_clusters</td>
<td>$core_clusters</td>
<td>$shell_clusters</td>
<td>$cloud_clusters</td>
</tr>
<tr>
<td>$∗_sequences</td>
<td>$core_sequences</td>
<td>$shell_sequences</td>
<td>$cloud_sequences</td>
</tr>
</tbody>
</table>
<ol type="a">
<li>As seen in the above table, the notation is quite straightforward. See example in Box 19 using $clusters to illustrate this better:
<div class="textbox">
<p><code>dim(p$clusters)[1]</code></p>
<p><code># [1] 7326</code></p>
<p><code>dim(p$core_clusters)[1]</code></p>
<p><code># [1] 1498</code></p>
<p><code>dim(p$shell_clusters)[1]</code></p>
<p><code># [1] 5010</code></p>
<p><code>dim(p$cloud_clusters)[1]</code></p>
<p><code># [1] 818</code></p>
</div>
</li>
</ol>
</li>
</ol>
<p>It can be appreciated that the total number of orthologous clusters in this pangenome is 7326, but only 1498 represent clusters of core genes.</p>
<ol start="18">
<li>
<b>Standard R subsetting notation.</b> Elements represented as matrices or vectors contained in the Pagoo object can be subsetted using standard R notation using square brackets. Let’s see a couple of examples.
<ol type="a">
<li>Subsetting the pangenome matrix (Box 20):
<div class="textbox">
<p><code>p$pan_matrix[1:3, 10:15]</code></p>
<p><code>#               accB  accB_1  accC  accC_1  accD  accD_2</code></p>
<p><code># 16244_6#1      1        0      1        0      1        0</code></p>
<p><code># 16244_6#10    1        0      1        0      1        0</code></p>
<p><code># 16244_6#11    1        0      1        0      1        0</code></p>
</div>
</li>
<li>Subsetting core sequences (Box 21):
<div class="textbox">
<p><code>p$core_sequences[c(1,30)]</code></p>
<p><code># DNAStringSetList of length 2</code></p>
<p><code># [["COQ2"]] 16244_6#1__16244_6#1_01627=ATGGCTAAATTTACTCAAATTTTAAAAGATATAAACGAA…</code></p>
<p><code># [["ansA"]] 16244_6#1__16244_6#1_00415=ATGTGCTTAAAAAAGGTGTTTATACTTATGCTGATTACG…</code></p>
</div>
</li>
</ol>
</li>
</ol>
<ol start="19">
<li>
<b>Dropping and recovering organisms.</b> The possibility of hiding certain organisms from the dataset is useful if we want to remove some genome with abnormal characteristics (i.e., potentially contaminated), if we want to focus just in a subset of genomes of interest given any metadata value, or if we included an outgroup for phylogenetic purposes but we want to discard it from downstream analyses. The following steps show how this works:.
<ol type="a">
<li>We are working with 168 organisms in the dataset, out of which 74 are from human origin (see Box 22):
<div class="textbox">
<p><code>table(p$organisms$Host)</code></p>
<p><code># Bovine Human Monkey Ovine Turtle</code></p>
<p><code># 78 74 1 13 2</code></p>
</div>
</li>
<li>We will hide these 74 from the dataset (see Box 23):
<div class="textbox">
<p><code>to_drop &lt;- which(p$organisms$host==</code><code>"</code><code>Human</code><code>"</code><code>)</code></p>
<p><code>p$drop(to_drop)</code></p>
<p><code>table(p$organisms$host)</code></p>
<p><code># Bovine  Monkey  Ovine  Turtle</code></p>
<p><code># 78        1      13        2</code></p>
</div>
<div class="note">
<span class="note-title">Note:</span> When the user hides a set of organisms, this will have an impact on all the information stored in the object. This means that all features associated with these genomes including genes, sequences, clusters and metadata will be hidden. It is important to note that the user does not have to reassign the object to a new one, it is self-modified (in place modification) according to R6 reference semantics.</div>
</li>
<li>To recover hidden organisms run the following (see Box 24):
<div class="textbox">
<p><code>dropped &lt;- p$dropped p$recover(dropped)</code></p>
</div>
</li>
</ol>
</li>
</ol>
<h3 id="sec3.6">Step 6: Built-in methods and visualizations</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 10 min</div>
<p>Pagoo provides basic but fundamental statistical analyses and visualizations for straightforward exploration of pangenome features. All these methods are embedded in the Pagoo object.</p>
<ol start="20">
<li>
<b>Principal Components Analysis (PCA).</b> PCA is a fundamental statistical tool that can be applied to pangenome data to see how organisms are grouped based on the diversity of their accessory genes. PCA can be calculated directly from the Pagoo object as follows (<a href="#fig1">Figure 1</a>):
<figure id="fig1"><img src="https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1048-Fig1.jpg" alt="Fig1.jpg">
<figcaption>
<div class="figcaption-title">Figure 1. Principal components analysis</div>
<p>A PCA is generated directly from the gene presence/absence matrix and in this case organisms are colored by host of origin.</p>
</figcaption>
</figure>
<ol type="a">
<li>Generate a standard PCA object for downstream analysis:
<div class="textbox">
<p><code>pca &lt;- p$pan_pca()</code></p>
</div>
</li>
<li>Directly visualizing the first 2 PCs using a biplot. This uses the previous method to perform the PCA but allows you to generate a customizable ggplot2 object on the fly (see Box 25):
<div class="textbox">
<p><code>p$gg_pca(color = "</code><code>Host</code><code>"</code><code>, size = 4) +</code></p>
<p>      <code>theme_bw(base_size = 15) +</code></p>
<p>      <code>scale_color_brewer(palette = "</code><code>Set2</code><code>"</code><code>)</code></p>
</div>
</li>
</ol>
</li>
</ol>
<ol start="21">
<li>
<b>Rarefaction curves.</b> Pangenome curves (<a href="#fig2">Figure 2</a>) show the number of gene clusters that are subsequently discovered as more genomes are added to the dataset. If the pangenome is open, more novel accessory genes will be discovered as new genomes are added and the size of the core genome will tend to decrease. Pagoo applies the Power-law distribution to fit the pangenome size and the Exponential decay function to fit the core genome size. Run this method and customize results as shown in Box 26:
<figure id="fig2"><img src="https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1048-Fig2.jpg" alt="Fig2.jpg">
<figcaption>
<div class="figcaption-title">Figure 2. Pangenome curves</div>
<p>Pangenome curves show the accessory and core genome size and are indicative of the gene pool size in a certain dataset.</p>
</figcaption>
</figure>
</li>
</ol>
<div class="textbox">
<p><code>p$gg_curves(size = 2) +</code></p>
<p>  <code>ggtitle(</code><code>"</code><code>Pangenome curves</code><code>"</code><code>) +</code></p>
<p>  <code>geom_point(alpha = 0.1, size = 4) +</code></p>
<p>  <code>theme_bw(base_size = 15) + ylim(0, 5000) +</code></p>
<p>  <code>scale_color_brewer(palette = "</code><code>Accent</code><code>"</code><code>)</code></p>
</div>
<ol start="22">
<li>
<b>Other methods.</b> Pagoo provides further methods for summary statistics whose application is analogous to the above described ones. These include pie charts using $gg_pie(), gene presence/absence bin maps using $gg_binmap() and gene frequency bar plots using $gg_barplot().</li>
<li>
<b>Dynamic visualization.</b> The above-mentioned plots for summary statistics can be deployed through a R Shiny application, allowing responsive and dynamic exploration of pangenome data. The application can be run as follows:</li>
</ol>
<div class="textbox">
<p><code>p$runShinyApp()</code></p>
</div>
<p><b>CAUTION:</b> The method described in step 23 (R-Shiny application) is currently not intended for very large datasets, as it may render slow. We recommend it to work with dozens to hundreds of genomes. For bigger pangenomes we recommend the use of the R command line.</p>
<div class="note">
<span class="note-title">Note:</span> An online example for a set of 69 genomes can be found here.</div>
<h3 id="sec3.7">Step 7: Downstream analyses using recipes</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 20 min</div>
<p>Here we show how Pagoo can interact with other R or external tools to generate more complex analyses. We introduce the concept of Pagoo recipes, that are concise pieces of code to complete different tasks. By using these recipes (or creating new ones) the user can take full profit of functionalities provided by Pagoo to perform a variety of analyses including phylogenetics, pangenome-wide association studies, sequence comparisons, ecological measures, preparation of publication-quality figures, among others. In this protocol, we provide a couple of examples of how to create these recipes, which can be found on GitHub.</p>
<ol start="24">
<li>
<b>Publication quality figures.</b> The following recipe (Box 27) allows to produce a publication quality figure showing pangenome main features using the previously mentioned methods (result shown in <a href="#fig3">Figure 3</a>), directly from the Pagoo object in the R session:
<figure id="fig3"><img src="https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1048-Fig3.jpg" alt="Fig3.jpg">
<figcaption>
<div class="figcaption-title">Figure 3. Visualization of pangenome features</div>
<p>Pagoo can be integrated with other R packages to produce publication-quality figures in a simple way. In this case, the figure shows an assembly of different analyses that summarize general features of this example pangenome: (A) pangenome curves, (B) gene frequency plots, (C) Accessory genes PCA and (D) pie chart with gene subsets.</p>
</figcaption>
</figure>
</li>
</ol>
<div class="textbox">
<p><code># 1. Pangenome curves</code></p>
<p><code>panel1 &lt;- p$gg_curves() +</code></p>
<p>    <code>scale_color_manual(values = c(</code><code>"</code><code>black</code><code>"</code><code>, "</code><code>black</code><code>"</code><code>)) +</code></p>
<p>    <code>geom_point(alpha = .05, size = 4, color = "</code><code>grey</code><code>"</code><code>) +</code></p>
<p>    <code>theme_bw(base_size = 15) +</code></p>
<p>    <code>labs(subtitle = "</code><code>A</code><code>"</code><code>) +</code></p>
<p>    <code>theme(legend.position = "</code><code>none</code><code>"</code><code>,</code></p>
<p>      <code>axis.title = element_text(size = 12),</code></p>
<p>      <code>axis.text = element_text(size = 12))</code></p>
<p><code># 2. Gene frequency bar plots</code></p>
<p><code>panel2 &lt;- p$gg_barplot() +</code></p>
<p>    <code>theme_bw(base_size = 15) +</code></p>
<p>    <code>labs(subtitle = "</code><code>B</code><code>"</code><code>) +</code></p>
<p>    <code>theme(axis.title = element_text(size = 12),</code></p>
<p>      <code>axis.text = element_text(size = 12)) +</code></p>
<p>    <code>geom_bar(stat = "</code><code>identity</code><code>"</code><code>, color = "</code><code>black</code><code>"</code><code>, fill = "</code><code>black</code><code>"</code><code>)</code></p>
<p><code># 3. PCA of accessory genes colored by host</code></p>
<p><code>panel3 &lt;- p$gg_pca(color = "</code><code>Host</code><code>"</code><code>, size = 4) +</code></p>
<p>    <code>theme_bw(base_size = 15) +</code></p>
<p>    <code>labs(subtitle = "</code><code>C</code><code>"</code><code>) +</code></p>
<p>    <code>guides(color = guide_legend(nrow = 2, byrow = T)) +</code></p>
<p>    <code>theme(legend.position = "</code><code>bottom</code><code>"</code><code>,</code></p>
<p>      <code>legend.title = element_blank(),</code></p>
<p>      <code>legend.text = element_text(size = 10),</code></p>
<p>      <code>axis.title = element_text(size = 12),</code></p>
<p>      <code>axis.text = element_text(size = 12))</code></p>
<p><code># 4. Pie chart of core and accessory genes</code></p>
<p><code>panel4 &lt;- p$gg_pie() + theme_bw(base_size = 15) +</code></p>
<p>    <code>scale_fill_brewer(palette = "</code><code>Blues</code><code>"</code><code>) +</code></p>
<p>    <code>scale_x_discrete(breaks = c(0, 25, 50, 75)) + labs(subtitle = "</code><code>D</code><code>"</code><code>) +</code></p>
<p>    <code>theme(legend.position = "</code><code>bottom</code><code>"</code><code>, legend.title = element_blank(),</code></p>
<p>      <code>legend.text = element_text(size = 10),</code></p>
<p>      <code>legend.margin = margin(0, 0, 13, 0), legend.box.margin = margin(0, 0, 5, 0),</code></p>
<p>      <code>axis.title = element_blank(), axis.ticks = element_blank(),</code></p>
<p>      <code>axis.text.x = element_blank())</code></p>
<p><code># 5. Use patchwork to arrange plots using math operators</code></p>
<p><code><b>library</b>(patchwork)</code></p>
<p><code>figure &lt;- (panel1 + panel2) / (panel3 + panel4)</code></p>
</div>
<div class="note">
<span class="note-title">Note:</span> Pagoo includes a responsive visualization dashboard through a R-Shiny application that allows the user to explore pangenome characteristics and perform standard comparative analyses like those shown in <a href="#fig3">Figure 3</a>. For a pangenome object named p, deploy the Shiny application running p$runShinyApp().</div>
<ol start="25">
<li>
<b>Core genome phylogeny and population structure.</b> The following recipe (Box 28) shows how to build a phylogenetic tree directly from the Pagoo object by using concatenated alignments of each individual core gene. This is performed by interacting with diverse R packages like Biostrings and DECIPHER (<a href="#bib8">Wright, 2015</a>) for sequence handling and alignment, phangorn (<a href="#bib5">Schliep, 2011</a>) for phylogenetic reconstruction, and ggtree (<a href="#bib9">Yu et al., 2017</a>) for tree visualization.</li>
</ol>
<div class="textbox">
<p><code># Load required packages</code></p>
<p><code><b>library</b>(magrittr)</code></p>
<p><code><b>library</b>(DECIPHER)</code></p>
<p><code><b>library</b>(Biostrings)</code></p>
<p><code><b>library</b>(phangorn)</code></p>
<p><code><b>library</b>(ggtree)</code></p>
<p><code><b>library</b>(rhierbaps)</code></p>
<p><code># Drop Cft and set core level to 100</code></p>
<p><code>cft &lt;- p$organisms[which(p$organisms$Subspecies==</code><code>"</code><code>Cft</code><code>"</code><code>),</code><code>"</code><code>org</code><code>"</code><code>]</code></p>
<p><code>p$drop(cft)</code></p>
<p><code>p$core_level &lt;- 100</code></p>
<p><code># Align individual core genes</code></p>
<p><code>ali &lt;- p$core_seqs_4_phylo() %&gt;%</code></p>
<p>  <code>lapply(DECIPHER::AlignTranslation)</code></p>
<p><code># Identify neutral core clusters using Tajima's D</code></p>
<p><code>tajD &lt;- ali %&gt;%</code></p>
<p>    <code>lapply(ape::as.DNAbin) %&gt;%</code></p>
<p>    <code>lapply(pegas::tajima.test) %&gt;%</code></p>
<p>    <code>sapply(</code><code>"</code><code>[[</code><code>"</code><code>, "</code><code>D</code><code>"</code><code>)</code></p>
<p><code>neutral &lt;- which(tajD &lt;= 2 &amp; tajD &gt;= -2)</code></p>
<p><code># Concatenate neutral core gene clusters</code></p>
<p><code>concat_neu &lt;- ali[neutral] %&gt;%</code></p>
<p>      <code>do.call(Biostrings::xscat, .) %&gt;%</code></p>
<p>      <code>setNames(p$organisms$org) %&gt;%</code></p>
<p>      <code>as(</code><code>"</code><code>matrix</code><code>"</code><code>) %&gt;%</code></p>
<p>      <code>tolower()</code></p>
<p><code># Find population structure with RhierBAPS</code></p>
<p><code>rhb &lt;- hierBAPS(snp.matrix = concat_neu, n.pops = 10,</code></p>
<p>        <code>max.depth = 1, n.extra.rounds = 5)</code></p>
<p><code># Add lineage information to organisms metadata</code></p>
<p><code>res &lt;- rhb$partition.df</code></p>
<p><code>lin &lt;- data.frame(org = as.character(res[, 1]),</code></p>
<p>          <code>lineage = as.factor(res[, 2]))</code></p>
<p><code>p$add_metadata(map = "</code><code>org</code><code>"</code><code>, data = lin)</code></p>
<p><code># Compute phylogeny</code></p>
<p><code>tre &lt;- concat_neu %&gt;%</code></p>
<p>  <code>phangorn::phyDat(type = "</code><code>DNA</code><code>"</code><code>) %&gt;%</code></p>
<p>  <code>phangorn::dist.ml() %&gt;%</code></p>
<p>  <code>phangorn::NJ()</code></p>
<p><code># Draw phylogeny with lineage and host information</code></p>
<p><code>gg1 &lt;- ggtree(tre, ladderize = T, layout = "</code><code>slanted</code><code>"</code><code>) %&lt;+%</code></p>
<p>  <code>as.data.frame(p$organisms) +</code></p>
<p>  <code>geom_tippoint(aes(color = as.factor(lineage))) +</code></p>
<p>  <code>labs(subtitle = "</code><code>A</code><code>"</code><code>) +</code></p>
<p>  <code>scale_color_discrete(</code><code>"</code><code>Lineage</code><code>"</code><code>)</code></p>
<p><code>gg2 &lt;- ggtree(tre, ladderize = T, layout = "</code><code>slanted</code><code>"</code><code>) %&lt;+%</code></p>
<p>  <code>as.data.frame(p$organisms) +</code></p>
<p>  <code>geom_tippoint(aes(colour = as.factor(Host))) +</code></p>
<p>  <code>labs(subtitle = "</code><code>B</code><code>"</code><code>) +</code></p>
<p>  <code>scale_colour_discrete(</code><code>"</code><code>Host</code><code>"</code><code>)</code></p>
<p><code>fig2 &lt;- gg1 + gg2</code></p>
</div>
<p>Results presented in <a href="#fig4">Figure 4</a> exemplify how a relatively complex task that needs of many steps like extracting core genes, keeping those that show signal of neutral evolution, aligning and concatenating them, determining population structure to finally perform a phylogenetic reconstruction, can be achieved directly from the Pagoo pangenome object with different sequential code recipes using different microbial genomics packages within the R environment.</p>
<figure id="fig4"><img src="https://prod-shared-star-protocols.s3.amazonaws.com/protocols/1048-Fig4.jpg" alt="Fig4.jpg">
<figcaption>
<div class="figcaption-title">Figure 4. Core genome phylogenies</div>
<p>This shows the output of the above-described recipe aiming to generate a core genome phylogeny directly from the pangenome object. Panel (A) shows the three colored by lineage defined in the same recipe through a population structure analysis and panel (B) shows the tree colored by host.</p>
</figcaption>
</figure>
<h3 id="sec3.8">Step 8: Saving and loading pangenome data</h3>
<div class="timing">
<span class="timing-title">Timing:</span> 5 min</div>
<p>Once the pangenome object is created, Pagoo provides two methods for saving and reloading it to a new R session:</p>
<ol start="26">
<li>Saving as plain text files (Box 29):</li>
</ol>
<div class="textbox">
<p><code>outdir &lt;- paste(</code><code>"</code><code>.</code><code>"</code><code>, "</code><code>my_pangenome</code><code>"</code><code>, sep = "/")</code></p>
<p><code>p$write_pangenome(dir = outdir)</code></p>
<p><code>list.files(outdir, full.names = TRUE)</code></p>
<p><code>## [1] "./my_pangenome/clusters.tsv"</code></p>
<p><code>## [2] "./my_pangenome/data.tsv"</code></p>
<p><code>## [3] "./my_pangenome/organisms.tsv"</code></p>
</div>
<p>This will create a directory with 3 text files. The advantage of this approach is that you can analyze it outside R, the disadvantage is that full reproducibility can be compromised since reading text could be less stable (classes or number precision can be lost).</p>
<ol start="27">
<li>Saving as R data format (Box 30):</li>
</ol>
<div class="textbox">
<p><code>rds &lt;- paste(</code><code>"</code><code>./my_pangenome</code><code>"</code><code>, "</code><code>pangenome.RDS</code><code>"</code><code>, sep = "/")</code></p>
<p><code>p$save_pangenomeRDS(file = rds)</code></p>
<p><code>p2 &lt;- load_pangenomeRDS(rds)</code></p>
</div>
<p>This solution preserves data structures, such as column data types (numeric, character or factor). So, this method is more stable (compatible between Pagoo versions), secure (uses the same metadata classes), and convenient (the exact state of the object can be saved and restored, keeping all modifications performed to the object during the analysis). Importantly, this option allows to store all pangenome data in a single and easily shareable file.</p>
<div class="note">
<span class="note-title">Note:</span> Authors recommend using the R data format for saving and loading Pagoo objects.</div>
</section>
<section>
<h2 id="expected-outcomes">Expected outcomes</h2>
<p>Pangenome analysis is a key approach to explore genetic diversity occurring in bacterial populations. Despite the availability of many different software tools for pangenome reconstruction, there are much less alternatives to perform downstream pangenome data analysis in a simple and standardized way. Pagoo is a flexible and extensible tool that systematize pagenome data in a single programming environment, allowing dynamic data analysis and integration with widely used packages for comparative genomics available in the R ecosystem. This protocol aims to be a guide for the use of Pagoo, providing the user with the fundamental skills to work with pangenome data within the R environment. Beyond the user will be able to perform standard phylogenetic analyses, genotype-phenotype association analyses or functional enrichment analyses, Pagoo is an open and flexible framework that allows the development of new modules or code recipes to fulfill specific tasks. Additionally, Pagoo facilitates data storage and sharing, since all data can be saved in a single file that can be recovered later in an independent R session or written to plain text.</p>
</section>
<section>
<h2 id="limitations">Limitations</h2>
<p>Despite the R ecosystem being vast and currently including dozens of packages that allow performing diverse comparative genomic analyses, it is possible that the user finds some specific tasks that are difficult to implement in R or are better covered by other pangenome analysis tools. Pagoo has been tested with hundreds to few thousands of genomes. A limiting aspect here is the time it can take to generate the Pagoo object from bigger datasets. This is particularly relevant for dynamic visualizations that Pagoo provides through its Shiny application.</p>
</section>
<section>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="sec6.1">Problem 1</h3>
<p>Copying and modifying the copy of a pangenome object also modifies the original one.</p>
<h3 id="sec6.2">Potential solution</h3>
<p>R6 classes are environments which use reference semantics. That means that these kinds of objects need a special method to get copied and if they are simply assigned to a new variable, this variable will point to the original one, and will not get duplicated. To avoid this, use the $clone() method to generate an independent copy of the object.</p>
<h3 id="sec6.3">Problem 2</h3>
<p>An error occurs when trying to load a pangenome.</p>
<h3 id="sec6.4">Potential solution</h3>
<p>Check that key columns (‘gene’, ‘cluster’, and ‘org’) contain the same elements between the different tables (gene, cluster and organisms). Pagoo checks that these match each other and raises an error if there are missing or different key values. See step 2, Boxes 2, 3, 4, 5, 6, 7, 8, and 9.</p>
<h3 id="sec6.5">Problem 3</h3>
<p>I dropped some organisms but I don’t remember which ones and also want to recover them.</p>
<h3 id="sec6.6">Potential solution</h3>
<p>Use the $dropped field to look if there are some hidden organisms, and then use the $recover() method to recover them. For example, if all dropped organisms want to be recovered from a pangenome object p, then use p$recover(p$dropped). See step 5, section 19.</p>
<h3 id="sec6.7">Problem 4</h3>
<p>The state of the pangenome object has changed after saving it and loading in a different R session.</p>
<h3 id="sec6.8">Potential solution</h3>
<p>Use save_pangenomeRDS() and load_pangenomeRDS() for saving and loading, respectively. This will load the pangenome object exactly in the same state as it was saved. See step 8, Box 30.</p>
</section>
<section>
<h2 id="references">References</h2>
<p id="bib1">Bayliss, S.C., Thorpe, H.A., Coyle, N.M., Sheppard, S.K., and Feil, E.J. (2019). PIRATE: A fast and scalable pangenomics toolbox for clustering diverged orthologues in bacteria. GigaScience <i>8</i>, giz119. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref1">View at publisher</a></p>
<p id="bib2">Ding, W., Baumdicker, F., and Neher, R.A. (2018). panX: pan-genome analysis and exploration. Nucleic Acids Res. <i>46</i>, e5. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref2">View at publisher</a></p>
<p id="bib11">Ferrés, I. and Iraola, G. (2021). An object-oriented framework for evolutionary pangenome analysis. Cell Reports Methods <i>1</i>. S2667-2375(21)00140-5. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/optPWfxPemzPW">View at publisher</a></p>
<p id="bib3">Iraola, G., Forster, S.C., Kumar, N., Lehours, P., Bekal, S., García-Peña, F.J., Paolicchi, F., Morsella, C., Hotzel, H., Hsueh, P.-R., et al. (2017). Distinct Campylobacter fetus lineages adapted as livestock pathogens and human pathobionts in the intestinal microbiota. Nat. Commun. <i>8</i>, 1367. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref3">View at publisher</a></p>
<p id="bib4">Page, A.J., Cummins, C.A., Hunt, M., Wong, V.K., Reuter, S., Holden, M.T.G., Fookes, M., Falush, D., Keane, J.A., and Parkhill, J. (2015). Roary: rapid large-scale prokaryote pan genome analysis. Bioinformatics <i>31</i>, 3691-3693. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref4">View at publisher</a></p>
<p id="bib5">Schliep, K.P. (2011). phangorn: phylogenetic analysis in R. Bioinformatics <i>27</i>, 592-593. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref5">View at publisher</a></p>
<p id="bib6">Seemann, T. (2014). Prokka: rapid prokaryotic genome annotation. Bioinformatics <i>30</i>, 2068-2069. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref6">View at publisher</a></p>
<p id="bib7">Tonkin-Hill, G., MacAlasdair, N., Ruis, C., Weimann, A., Horesh, G., Lees, J.A., Gladstone, R.A., Lo, S., Beaudoin, C., Floto, R.A., et al. (2020). Producing polished prokaryotic pangenomes with the Panaroo pipeline. Genome Biol. <i>21</i>, 180. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref7">View at publisher</a></p>
<p id="bib8">Wright, E.S. (2015). DECIPHER: harnessing local sequence context to improve protein multiple sequence alignment. BMC Bioinformatics <i>16</i>, 322. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref8">View at publisher</a></p>
<p id="bib9">Yu, G., Smith, D.K., Zhu, H., Guan, Y., and Lam, T.T.-Y. (2017). ggtree: an r package for visualization and annotation of phylogenetic trees with their covariates and other associated data. Methods Ecol. Evol. <i>8</i>, 28-36. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref9">View at publisher</a></p>
<p id="bib10">Zhou, Z., Charlesworth, J., and Achtman, M. (2020). Accurate reconstruction of bacterial pan- and core genomes with PEPPAN. Genome Res. <i>30</i>, 1667-1679. <a class="external-link" href="http://refhub.elsevier.com/S2666-1667(21)00508-6/sref10">View at publisher</a></p>
</section>
<section>
<h2 id="article-info">Article info</h2>
<h3>Resource availability</h3>
<h4>Lead contact</h4>
<p>Further information and requests for resources and reagents should be directed to and will be fulfilled by the lead contact, Gregorio Iraola (<a href="mailto:giraola@pasteur.edu.uy">giraola@pasteur.edu.uy</a>).</p>
<h4>Materials availability</h4>
<p>This study did not generate new unique reagents.</p>
<h4>Data and code availability</h4>
<p>The published article includes all datasets/code generated or analyzed during this study.</p>
<h3>Acknowledgments</h3>
<p>This work has been partially funded by Banco de Seguros del Estado (BSE) from Uruguay and Fondo de Convergencia Estructural del Mercosur (FOCEM) grant COF 03/11. I.F. is funded by grant ANII-POS_NAC_2018_1_151494 from Agencia Nacional de Investigación e Innovación (<a href="https://doi.org/10.13039/100008725">ANII</a>), Uruguay. We thank Pablo Fresia, Andrés Parada, and Daniela Costa for insightful comments and suggestions during testing of Pagoo.</p>
<h3>Author contributions</h3>
<p>I.F. and G.I. conceived the idea. I.F. developed software and generated the analytical protocols described here. I.F. and G.I. wrote the manuscript.</p>
<h3>Declaration of interests</h3>
<p>The authors declare no competing interests.</p>
</section>
</article>